services:
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
#    ports:
#      - "3000:3000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config-homepage/bookmarks.yaml:/app/config/bookmarks.yaml
      - ./config-homepage/docker.yaml:/app/config/docker.yaml
      - ./config-homepage/services.yaml:/app/config/services.yaml
      - ./config-homepage/settings.yaml:/app/config/settings.yaml
      - ./config-homepage/widgets.yaml:/app/config/widgets.yaml
      - ./config-homepage/icons:/app/public/icons
    restart: unless-stopped
    environment:
      - TZ=Europe/Paris
      - HOMEPAGE_ALLOWED_HOSTS=*
      - HOMEPAGE_VAR_TITLE=Dashboard_de_test
      - HOMEPAGE_DOCKER=1
      - DOCKER_HOST=unix:///var/run/docker.sock
      #disableUpdateCheck
      - HOMEPAGE_VAR_DISABLE_UPDATE_CHECK=1
      - HOMEPAGE_VAR_DISABLEUPDATECHECK=1
      - HOMEPAGE_VAR_HIDE_VERSION=1 
      - HOMEPAGE_VAR_HIDEVERSION=1 
    networks:
      - no-internet
      - traefik
    labels:
      - "traefik.enable=true"
#      - "traefik.http.routers.homepage.rule=Host(`hub.loc.ovh`)"
#      - "traefik.http.routers.homepage.entrypoints=web,websecure"
#      - "traefik.http.routers.homepage.tls=true"
#      - "traefik.http.services.homepage.loadbalancer.server.port=3000"

      # Middleware qui retourne une erreur 403
      - "traefik.http.middlewares.block-api-releases.replacepathregex.regex=^/api/releases(.*)"
      - "traefik.http.middlewares.block-api-releases.replacepathregex.replacement=/blocked"
      
      # Routeur pour /api/releases -> erreur
      - "traefik.http.routers.homepage-block.rule=Host(`hub.loc.ovh`) && Path(`/api/releases`)"
      - "traefik.http.routers.homepage-block.entrypoints=web,websecure"
      - "traefik.http.routers.homepage-block.tls=true"
      - "traefik.http.services.homepage-block.loadbalancer.server.port=3000"
      - "traefik.http.routers.homepage-block.middlewares=block-api-releases@docker"
      
      # Routeur normal pour le reste
      - "traefik.http.routers.homepage.rule=Host(`hub.loc.ovh`)"
      - "traefik.http.routers.homepage.entrypoints=web,websecure"
      - "traefik.http.routers.homepage.tls=true"
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --interval 3600 --cleanup
    networks:
      - custom-network
    labels:
      - "homepage.group=Admin"
      - "homepage.name=Watchtower"
      - "homepage.icon=watchtower.png"
      - "homepage.description=Mises Ã  jour automatiques des conteneurs"

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - no-internet
      - custom-network
      - traefik
    restart: unless-stopped
    labels:
      - "homepage.group=Admin"
      - "homepage.name=Portainer"
      - "homepage.icon=portainer.png"
      - "homepage.href=https://portainer.loc.ovh/"
      - "homepage.description=Gestionnaire Docker"
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`portainer.loc.ovh`)"
      - "traefik.http.routers.portainer.entrypoints=web,websecure"
      - "traefik.http.routers.portainer.tls=true"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

volumes:
  portainer_data:
